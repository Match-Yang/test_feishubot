name: send_feishu_notification

on:
  workflow_run:
    workflows: [prepare_pr_info]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download PR info
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "pr-info"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync('pr-info.zip', Buffer.from(download.data));

      - name: Extract PR info
        run: |
          unzip pr-info.zip
          if [ -f pr_info.txt ]; then
            sed -i 's/\r$//' pr_info.txt
            source pr_info.txt
            {
              echo "PR_TITLE=${pr_title}"
              echo "PR_URL=${pr_url}"
              echo "EVENT_TYPE=${event_type}"
              echo "PR_ACTION=${action}"
              echo "PR_BODY=${pr_body}"
              echo "PR_CREATOR=${pr_creator}"
              echo "PR_MERGED=${pr_merged}"
              echo "REVIEW_BODY=${review_body}"
              echo "REVIEW_STATE=${review_state}"
              echo "REVIEWER=${reviewer}"
              echo "COMMENT_BODY=${comment_body}"
              echo "COMMENT_USER=${comment_user}"
            } >> $GITHUB_ENV
          else
            echo "错误：找不到 pr_info.txt 文件"
            exit 1
          fi

      - name: Send notifications
        env:
          WEBHOOK_UIKIT: ${{ secrets.WEBHOOK_UIKIT }}
          WEBHOOK_ZIM: ${{ secrets.WEBHOOK_ZIM }}
        run: python .github/scripts/send_notification.py