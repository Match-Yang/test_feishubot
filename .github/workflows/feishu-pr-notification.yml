name: PR Notification to Feishu

on:
  pull_request_target:
    types: 
      - assigned
      - opened
      - synchronize
      - reopened
      - closed
      - review_requested
      - converted_to_draft
      - ready_for_review
      - review_request_removed
  issue_comment:
    types: [created, edited, deleted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check secrets
        run: |
          echo "æ£€æŸ¥ secrets é…ç½®..."
          echo "WEBHOOK_UIKIT: ${{ secrets.WEBHOOK_UIKIT != '' }}"
          echo "API_KEY_UIKIT: ${{ secrets.API_KEY_UIKIT != '' }}"
          echo "WEBHOOK_ZIM: ${{ secrets.WEBHOOK_ZIM != '' }}"
          echo "API_KEY_ZIM: ${{ secrets.API_KEY_ZIM != '' }}"
          echo "æµ‹è¯• Variables: ${{ vars.TEST_WEBHOOK }}"

      - name: Load user mapping
        id: mapping
        run: |
          echo "å¼€å§‹åŠ è½½ç”¨æˆ·æ˜ å°„..."
          if [ -f .github/configs/user_mapping.yml ]; then
            cat .github/configs/user_mapping.yml
            while IFS=: read -r github_user feishu_id || [ -n "$github_user" ]; do
              [[ $github_user =~ ^#.*$ || -z $github_user ]] && continue
              github_user=$(echo $github_user | tr -d ' "')
              feishu_id=$(echo $feishu_id | tr -d ' "')
              echo "æ˜ å°„: GitHubç”¨æˆ· ${github_user} -> é£ä¹¦ç”¨æˆ· ${feishu_id}"
              echo "FEISHU_${github_user}=${feishu_id}" >> $GITHUB_ENV
            done < .github/configs/user_mapping.yml
          else
            echo "è­¦å‘Š: ç”¨æˆ·æ˜ å°„æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: Send notification
        env:
          WEBHOOK_UIKIT: ${{ secrets.WEBHOOK_UIKIT }}
          API_KEY_UIKIT: ${{ secrets.API_KEY_UIKIT }}
          WEBHOOK_ZIM: ${{ secrets.WEBHOOK_ZIM }}
          API_KEY_ZIM: ${{ secrets.API_KEY_ZIM }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_CREATOR: ${{ github.event.pull_request.user.login }}
          PR_ACTION: ${{ github.event.action }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEW_STATE: ${{ github.event.review.state }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          IS_PR_COMMENT: ${{ github.event.issue.pull_request != '' }}
          EVENT_TYPE: ${{ github.event_name }}
        run: |
          echo "å¼€å§‹å¤„ç†PRé€šçŸ¥..."
          echo "ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "WEBHOOK_UIKIT æ˜¯å¦è®¾ç½®: ${WEBHOOK_UIKIT:+true}"
          echo "API_KEY_UIKIT æ˜¯å¦è®¾ç½®: ${API_KEY_UIKIT:+true}"
          
          # æ‰“å°äº‹ä»¶ä¿¡æ¯
          echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "äº‹ä»¶åŠ¨ä½œ: ${{ github.event.action }}"
          
          # è·å–PRä¿¡æ¯
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          GITHUB_USER="${{ github.event.pull_request.user.login }}"
          
          echo "PRæ ‡é¢˜: ${PR_TITLE}"
          echo "PRé“¾æ¥: ${PR_URL}"
          echo "PRåˆ›å»ºè€…: ${GITHUB_USER}"
          
          # å°† GitHub ç”¨æˆ·åä¸­çš„ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
          SAFE_GITHUB_USER=$(echo "${GITHUB_USER}" | tr '-' '_')
          FEISHU_USER_VAR="FEISHU_${SAFE_GITHUB_USER}"
          FEISHU_USER_ID="${!FEISHU_USER_VAR}"
          
          # æ ¹æ®æ˜¯å¦æœ‰é£ä¹¦ç”¨æˆ·IDæ¥å†³å®šæ˜¯å¦ä½¿ç”¨atæ ‡è®°
          if [[ -n "${FEISHU_USER_ID}" ]]; then
            CREATOR_TEXT="**åˆ›å»ºè€…**: <at id=${FEISHU_USER_ID}></at>"
          else
            CREATOR_TEXT="**åˆ›å»ºè€…**: ${GITHUB_USER}"
          fi
          
          # æ ¹æ®ä¸åŒäº‹ä»¶ç±»å‹è®¾ç½®çŠ¶æ€å’Œå†…å®¹
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            if [[ "${{ github.event.action }}" == "opened" ]]; then
              STATUS="ğŸ†• æ–°å»º PR"
              EXTRA_CONTENT="\n**æè¿°**: ${PR_BODY}"
            elif [[ "${{ github.event.action }}" == "closed" ]]; then
              if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                STATUS="âœ… PR å·²åˆå¹¶"
              else
                STATUS="âŒ PR å·²å…³é—­"
              fi
            else
              STATUS="ğŸ”„ PR æ›´æ–°"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            REVIEWER="${{ github.event.review.user.login }}"
            SAFE_REVIEWER=$(echo "${REVIEWER}" | tr '-' '_')
            REVIEWER_VAR="FEISHU_${SAFE_REVIEWER}"
            REVIEWER_ID="${!REVIEWER_VAR}"
            
            if [[ -n "${REVIEWER_ID}" ]]; then
              REVIEWER_TEXT="**è¯„å®¡è€…**: <at id=${REVIEWER_ID}></at>"
            else
              REVIEWER_TEXT="**è¯„å®¡è€…**: ${REVIEWER}"
            fi
            
            if [[ "${{ github.event.review.state }}" == "approved" ]]; then
              STATUS="ğŸ‘ å®¡æ ¸é€šè¿‡"
            elif [[ "${{ github.event.review.state }}" == "changes_requested" ]]; then
              STATUS="ğŸ“ éœ€è¦ä¿®æ”¹"
            elif [[ "${{ github.event.review.state }}" == "commented" ]]; then
              STATUS="ğŸ’¬ æ”¶åˆ°è¯„å®¡æ„è§"
            fi
            EXTRA_CONTENT="\n${REVIEWER_TEXT}\n**è¯„å®¡æ„è§**: ${REVIEW_BODY}"
          elif [[ "${{ github.event_name }}" == "issue_comment" && "$IS_PR_COMMENT" == "true" ]]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            SAFE_COMMENTER=$(echo "${COMMENTER}" | tr '-' '_')
            COMMENTER_VAR="FEISHU_${SAFE_COMMENTER}"
            COMMENTER_ID="${!COMMENTER_VAR}"
            
            if [[ -n "${COMMENTER_ID}" ]]; then
              COMMENTER_TEXT="**è¯„è®ºè€…**: <at id=${COMMENTER_ID}></at>"
            else
              COMMENTER_TEXT="**è¯„è®ºè€…**: ${COMMENTER}"
            fi
            
            STATUS="ğŸ’¬ PRè¯„è®º"
            EXTRA_CONTENT="\n${COMMENTER_TEXT}\n**è¯„è®ºå†…å®¹**: ${COMMENT_BODY}"
            
            # å¯¹äº issue_comment äº‹ä»¶ï¼Œéœ€è¦ç‰¹åˆ«å¤„ç† PR URL
            PR_URL="${{ github.event.issue.pull_request.html_url }}"
            PR_TITLE="${{ github.event.issue.title }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            STATUS="ğŸ”¨ æ¨é€åˆ°ä¸»åˆ†æ”¯"
            EXTRA_CONTENT="\n**åˆ†æ”¯**: main"
          else
            STATUS="âš¡ PR æ´»åŠ¨"
            EXTRA_CONTENT=""
          fi
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          CONTENT="**çŠ¶æ€**: ${STATUS}\n${CREATOR_TEXT}${EXTRA_CONTENT}"
          
          # æ›´æ–°æ¶ˆæ¯å¡ç‰‡ä¸­çš„å†…å®¹
          MESSAGE_CARD=$(cat << EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "${PR_TITLE}"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**çŠ¶æ€**: ${STATUS}\n${CREATOR_TEXT}${EXTRA_CONTENT}"
                  }
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "lark_md",
                        "content": "æŸ¥çœ‹ PR ğŸ‘‰"
                      },
                      "url": "${PR_URL}",
                      "type": "default"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )
          
          # åªåœ¨æœ‰ PR ç›¸å…³äº‹ä»¶æ—¶è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          if [[ "${{ github.event_name }}" == "pull_request_target" || "${{ github.event_name }}" == "pull_request_review" || "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨..."
            changed_files=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" --jq '.[].filename')
            echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨:"
            echo "$changed_files"
            
            echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´èŒƒå›´..."
            while IFS= read -r file; do
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              if [[ $file == uikit/* ]]; then
                echo "å‘ç° UIKit ç›¸å…³å˜æ›´"
                notify_uikit=true
              elif [[ $file == core_products/zim/* ]]; then
                echo "å‘ç° ZIM ç›¸å…³å˜æ›´"
                notify_zim=true
              fi
            done <<< "$changed_files"
          else
            # å¯¹äº push äº‹ä»¶ï¼Œé»˜è®¤é€šçŸ¥æ‰€æœ‰å›¢é˜Ÿ
            notify_uikit=true
            notify_zim=true
          fi
          
          send_notification() {
            local webhook_url="$1"
            local api_key="$2"
            local team="$3"
            
            echo "å‡†å¤‡å‘é€é€šçŸ¥åˆ° ${team} å›¢é˜Ÿ..."
            
            # ç›´æ¥å‘é€è¯·æ±‚ï¼Œä¸è¿›è¡Œç­¾åéªŒè¯
            echo "å‘é€è¯·æ±‚åˆ°é£ä¹¦æœºå™¨äºº..."
            response=$(curl -X POST \
                 -H "Content-Type: application/json" \
                 -d "$MESSAGE_CARD" \
                 "$webhook_url")
            echo "é£ä¹¦å“åº”: $response"
          }
          
          if [[ $notify_uikit == true && -n $WEBHOOK_UIKIT && -n $API_KEY_UIKIT ]]; then
            echo "å‘é€é€šçŸ¥åˆ° UIKit å›¢é˜Ÿ..."
            send_notification "$WEBHOOK_UIKIT" "$API_KEY_UIKIT" "UIKit"
          else
            echo "è·³è¿‡ UIKit å›¢é˜Ÿé€šçŸ¥"
            [[ $notify_uikit == false ]] && echo "åŸå› : æ²¡æœ‰ç›¸å…³å˜æ›´"
            [[ -z $WEBHOOK_UIKIT ]] && echo "åŸå› : ç¼ºå°‘ WEBHOOK_UIKIT"
            [[ -z $API_KEY_UIKIT ]] && echo "åŸå› : ç¼ºå°‘ API_KEY_UIKIT"
          fi
          
          if [[ $notify_zim == true && -n $WEBHOOK_ZIM && -n $API_KEY_ZIM ]]; then
            echo "å‘é€é€šçŸ¥åˆ° ZIM å›¢é˜Ÿ..."
            send_notification "$WEBHOOK_ZIM" "$API_KEY_ZIM" "ZIM"
          else
            echo "è·³è¿‡ ZIM å›¢é˜Ÿé€šçŸ¥"
            [[ $notify_zim == false ]] && echo "åŸå› : æ²¡æœ‰ç›¸å…³å˜æ›´"
            [[ -z $WEBHOOK_ZIM ]] && echo "åŸå› : ç¼ºå°‘ WEBHOOK_ZIM"
            [[ -z $API_KEY_ZIM ]] && echo "åŸå› : ç¼ºå°‘ API_KEY_ZIM"
          fi