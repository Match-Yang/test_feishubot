name: PR Notification to Feishu

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches:
      - main
    paths:
      - 'uikit/**'
      - 'core_products/zim/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Load user mapping
        id: mapping
        run: |
          # 读取用户映射并转换为环境变量
          while IFS=: read -r github_user feishu_id || [ -n "$github_user" ]; do
            # 跳过注释行和空行
            [[ $github_user =~ ^#.*$ || -z $github_user ]] && continue
            # 去除多余空格和引号
            github_user=$(echo $github_user | tr -d ' "')
            feishu_id=$(echo $feishu_id | tr -d ' "')
            echo "FEISHU_${github_user}=${feishu_id}" >> $GITHUB_ENV
          done < .github/configs/user_mapping.yml

      - name: Send notification
        env:
          WEBHOOK_UIKIT: ${{ secrets.WEBHOOK_UIKIT }}
          WEBHOOK_ZIM: ${{ secrets.WEBHOOK_ZIM }}
        run: |
          # 获取PR信息
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          GITHUB_USER="${{ github.event.pull_request.user.login }}"
          
          # 获取对应的飞书用户ID
          FEISHU_USER_VAR="FEISHU_${GITHUB_USER}"
          FEISHU_USER_ID="${!FEISHU_USER_VAR:-$GITHUB_USER}"
          
          # 确定PR状态
          if [[ "${{ github.event.action }}" == "opened" ]]; then
            STATUS="新建PR"
          elif [[ "${{ github.event.action }}" == "synchronize" ]]; then
            STATUS="更新PR"
          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              STATUS="合并PR"
            else
              STATUS="关闭PR"
            fi
          fi
          
          # 构建消息内容
          MESSAGE_CARD=$(cat << EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "${PR_TITLE}"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**状态**: ${STATUS}\n**创建者**: <at id=${FEISHU_USER_ID}></at>\n**描述**: ${PR_BODY:-无}"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "查看 PR"
                      },
                      "url": "${PR_URL}",
                      "type": "default"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )
          
          # 检查变更文件并发送通知
          changed_files=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" --jq '.[].filename')
          
          # 初始化通知标志
          notify_uikit=false
          notify_zim=false
          
          # 检查每个文件
          while IFS= read -r file; do
            if [[ $file == uikit/* ]]; then
              notify_uikit=true
            elif [[ $file == core_products/zim/* ]]; then
              notify_zim=true
            fi
          done <<< "$changed_files"
          
          # 发送通知
          send_notification() {
            local webhook_url="$1"
            curl -X POST -H "Content-Type: application/json" \
                 -d "$MESSAGE_CARD" \
                 "$webhook_url"
          }
          
          # 根据变更发送到相应的机器人
          if [[ $notify_uikit == true && -n $WEBHOOK_UIKIT ]]; then
            send_notification "$WEBHOOK_UIKIT"
          fi
          
          if [[ $notify_zim == true && -n $WEBHOOK_ZIM ]]; then
            send_notification "$WEBHOOK_ZIM"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}